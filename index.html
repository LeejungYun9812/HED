<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>í˜„ëŒ€ì—ë²„ë‹¤ì„ ë¬´ìƒí’ˆ ì†Œìš”ëŸ‰ ê³„ì‚°ê¸°</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<!-- ğŸ“„ PDF & Excel ë‚´ë³´ë‚´ê¸° ë¼ì´ë¸ŒëŸ¬ë¦¬ ì¶”ê°€ -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.1/jspdf.plugin.autotable.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<style>
:root {
  --color-primary: #009688;
  --color-secondary: #CC9933;
  --color-danger: #dc3545;
  --color-light: #f4f7f6;
}
body{font-family:'Noto Sans KR',sans-serif;background:var(--color-light);margin:0;}
.container{max-width:900px;margin:20px auto;background:white;padding:30px;border-radius:4px;box-shadow:0 2px 5px rgba(0,0,0,0.05);position:relative;}
.header-section{text-align:center;margin-bottom:20px;}
#ciLogo{max-width:180px;height:auto;margin-bottom:10px;}
.title{color:var(--color-primary);font-size:26px;font-weight:700;margin:0;}
#adminButton{position:absolute;top:20px;right:30px;background:var(--color-secondary);color:white;border:none;border-radius:4px;padding:8px 15px;font-weight:700;cursor:pointer;}
h3{border-bottom:3px solid var(--color-primary);padding-bottom:8px;}
button{cursor:pointer;border:none;border-radius:4px;padding:8px 15px;font-weight:700;}
#calculateButton{background:var(--color-primary);color:white;}
.action-btn{background:var(--color-secondary);color:white;margin-right:8px;}
table{width:100%;border-collapse:collapse;margin-top:15px;}
th,td{border:1px solid #eee;padding:8px;text-align:left;font-size:13px;}
th{background:var(--color-light);}
#supplyPanel{position:fixed;top:50%;right:10px;width:250px;transform:translateY(-50%);background:white;border:2px solid var(--color-secondary);border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.1);padding:10px;font-size:12.5px;}
#supplyPanel h4{text-align:center;margin-top:0;color:var(--color-primary);font-size:14px;}
.supply-item{margin:6px 0;padding:6px;border:1px solid #ddd;border-radius:6px;}
.status{font-weight:bold;}
.danger{color:var(--color-danger);}
.supply-header{display:flex;justify-content:space-between;align-items:center;font-size:12px;}
#pagination{text-align:center;margin-top:10px;}
.page-btn{background:none;border:none;font-size:14px;margin:0 5px;cursor:pointer;color:var(--color-primary);font-weight:bold;}
.page-btn.active{text-decoration:underline;color:var(--color-danger);}
#adminSection{display:none;border:1px solid var(--color-secondary);background:#fffaf0;padding:20px;margin-top:20px;}
.filter-bar select{margin-right:10px;padding:6px;}
@media print{#supplyPanel,#adminButton,#calculateButton,#addRowButton,.report-buttons,#adminSection{display:none!important;}}
</style>
</head>

<body>
<div class="container">
  <button id="adminButton" onclick="toggleAdminMode()">ê´€ë¦¬ì ëª¨ë“œ ì—´ê¸°</button>
  <div class="header-section">
    <img id="ciLogo" src="everdigm_logo.png" alt="í˜„ëŒ€ì—ë²„ë‹¤ì„ CI ë¡œê³ ">
    <h1 class="title">ë¬´ìƒí’ˆ ì†Œìš”ëŸ‰ ê³„ì‚°ê¸°</h1>
  </div>

  <h3>ë°œì£¼ ì¡°í•© ì…ë ¥</h3>
  <div id="orderInputs"></div>
  <button onclick="addRow()">+ ì¡°í•© ì¶”ê°€</button>
  <button id="calculateButton" onclick="calculateRequirements()">ì´ ì†Œìš”ëŸ‰ ê³„ì‚°</button>

  <div class="report-buttons" id="reportBtns" style="display:none;text-align:right;margin-top:15px;">
    <button class="action-btn" onclick="downloadPDF()">ğŸ“„ PDF ë‚´ë³´ë‚´ê¸°</button>
    <button class="action-btn" onclick="downloadExcel()">ğŸ’¾ Excel ë‚´ë³´ë‚´ê¸°</button>
  </div>

  <h3>ì´ ì†Œìš”ëŸ‰ ê²°ê³¼</h3>
  <table id="resultTable">
    <thead><tr><th>í’ˆë²ˆ</th><th>í’ˆëª…</th><th>ì´ ì†Œìš” ìˆ˜ëŸ‰</th><th>ë¹„ê³ </th></tr></thead>
    <tbody><tr><td colspan="4" style="text-align:center;">ì¡°í•©ì„ ì…ë ¥í•˜ê³  ê³„ì‚° ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.</td></tr></tbody>
  </table>
</div>

<!-- âœ… ìš°ì¸¡ íŒ¨ë„: ì†Œëª¨í’ˆ ë°œì£¼ ê´€ë¦¬ -->
<div id="supplyPanel">
  <h4>ì†Œëª¨í’ˆ ë°œì£¼ í˜„í™©</h4>
  <div id="supplyList"></div>
</div>

<!-- âœ… ê´€ë¦¬ì ëª¨ë“œ (í•„í„°, ì‚­ì œ, í˜ì´ì§€ í¬í•¨) -->
<div class="container" id="adminSection">
  <h3>âš™ï¸ ë§ˆìŠ¤í„° ë°ì´í„° ê´€ë¦¬</h3>
  <textarea id="csvTextarea" rows="8" placeholder="ì—‘ì…€ ë°ì´í„° ë³µì‚¬ â†’ ë¶™ì—¬ë„£ê¸° (ê¸°ì¢…, ì•„ì´í…œ, ë”œëŸ¬, í’ˆë²ˆ, í’ˆëª…, ìˆ˜ëŸ‰, ë¹„ê³  ìˆœ)" style="width:100%;"></textarea>
  <button class="action-btn" onclick="uploadMasterDataFromText()">ğŸ“‹ í…ìŠ¤íŠ¸ ë°ì´í„° ì¶”ê°€</button>

  <div class="filter-bar" style="margin-top:15px;">
    <select id="filterDealer" onchange="applyFilter()"><option value="">-- ë”œëŸ¬ ì „ì²´ --</option></select>
    <select id="filterItem" onchange="applyFilter()"><option value="">-- ì•„ì´í…œ ì „ì²´ --</option></select>
    <button class="action-btn" onclick="deleteByFilter()">ğŸ—‘ í•„í„° ì¡°ê±´ ë°ì´í„° ì‚­ì œ</button>
  </div>

  <div style="margin-top:10px;display:flex;justify-content:space-between;align-items:center;">
    <div>
      <button class="action-btn" onclick="selectAll(true)">â˜‘ ì „ì²´ì„ íƒ</button>
      <button class="action-btn" onclick="selectAll(false)">â¬œ ì„ íƒí•´ì œ</button>
      <button class="action-btn" onclick="deleteSelected()">âœ” ì„ íƒ í•­ëª© ì‚­ì œ</button>
    </div>
    <button class="action-btn" style="background:#dc3545;" onclick="deleteAll()">ğŸ—‘ ì „ì²´ ì‚­ì œ</button>
  </div>

  <table id="dataListTable" style="margin-top:15px;">
    <thead><tr><th>ì„ íƒ</th><th>ë”œëŸ¬</th><th>ì•„ì´í…œ</th><th>ê¸°ì¢…</th><th>í’ˆë²ˆ</th><th>í’ˆëª…</th><th>ì†Œìš”ìˆ˜ëŸ‰</th><th>ë¹„ê³ </th></tr></thead>
    <tbody></tbody>
  </table>
  <div id="pagination"></div>
</div>

<script>
const LOCAL_STORAGE_KEY='everdigm_attachment_master_data';
const SUPPLY_KEY='everdigm_supply_counter';
const ADMIN_PASSWORD='êµ¬ë§¤íŒ€ì§±';
let isAdminMode=false,currentPage=1,ROWS_PER_PAGE=20,filteredData=[];

let supplyData=JSON.parse(localStorage.getItem(SUPPLY_KEY))||{
  'A090-0007':0,'A090-0021':0,'A090-0052':0,'A090-0054':0
};

const groups={
  nitrogen_large:["EHB05","EHB06","EHB10","EHB13","EHB17","EHB20","EHB25","EHB30","EHB40","EHB50","EHB70","EHB85","EHB100","EH 01","EH 02","EH 03","EH 04","EH 05","EH 06","EH 22","EH 31","EH 40","EH 50","PRB050","PRB060","PRB100","PRB150","PRB170","PRB200","PRB250","PRB300","EHB35","PRB400","PRB500","PRB700","RHB340","RHB350","RHB370"],
  nitrogen_small:["EHB008","EHB01","EHB02","EHB03","EHB04","EH 13","EH 10","PRB008","PRB010","PRB020","PRB030","PRB040"],
  gas_small:["EHB008","EHB01","EHB02","EHB03","EHB04","EHB05","EHB06","EHB10","EHB13","EH 01","EH 02","EH 03","EH 04","EH 05","EH 06","PRB008","PRB010","PRB020","PRB030","PRB040","PRB050","PRB060","PRB100","PRB150","RHB301","RHB302","RHB303","RHB304","RHB305","RHB306","RHB310","RHB313"],
  gas_large:["EHB17","EHB20","EHB25","EHB30","EHB40","EHB50","EHB70","EHB85","EHB100","EH 10","EH 13","EH 22","EH 31","EH 40","EH 50","PRB170","PRB200","PRB250","PRB300","EHB35","PRB400","PRB500","PRB700","RHB317","RHB320","RHB325","RHB330","RHB340","RHB350","RHB370","RHB340","RHB350","RHB370"]
};

function saveSupply(){localStorage.setItem(SUPPLY_KEY,JSON.stringify(supplyData));}
function updateSupplyPanel(){
  const list=document.getElementById('supplyList');
  list.innerHTML='';
  const items=[
    {code:'A090-0021',name:'NITROGEN GAS BOTTLE (ì†Œí˜•)'},
    {code:'A090-0007',name:'NITROGEN GAS BOTTLE (ëŒ€í˜•)'},
    {code:'A090-0052',name:'GAS CHARGING KIT (ì†Œí˜•)'},
    {code:'A090-0054',name:'GAS CHARGING KIT (ëŒ€í˜•)'}
  ];
  items.forEach(i=>{
    const div=document.createElement('div');
    div.className='supply-item';
    div.innerHTML=`
      <div class="supply-header" style="flex-direction:column;align-items:flex-start;">
        <span style="margin-bottom:4px;"><b>[${i.code}]</b><br>${i.name}</span>
        <button style="align-self:flex-end;background:#999;color:white;padding:2px 6px;font-size:11px;border:none;border-radius:3px;" onclick="resetOne('${i.code}')">ë°œì£¼ì™„ë£Œ</button>
      </div>
      <div class="status ${supplyData[i.code]>=50?'danger':''}">
        ${supplyData[i.code]}ê°œ${supplyData[i.code]>=50?' âš  ë°œì£¼ í•„ìš”':''}
      </div>`;
    list.appendChild(div);
  });
}
function resetOne(code){supplyData[code]=0;saveSupply();updateSupplyPanel();alert(`[${code}] ì´ˆê¸°í™” ì™„ë£Œ.`);}

function loadMasterData(){const d=localStorage.getItem(LOCAL_STORAGE_KEY);return d?JSON.parse(d):[];}
function saveMasterData(d){localStorage.setItem(LOCAL_STORAGE_KEY,JSON.stringify(d));}

function toggleAdminMode(){
  const admin=document.getElementById('adminSection');
  if(!isAdminMode){const pw=prompt("ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:");if(pw===ADMIN_PASSWORD){isAdminMode=true;admin.style.display='block';refreshFilters();applyFilter();}else alert("ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.");}
  else{isAdminMode=false;admin.style.display='none';}
}

function addRow(){
  const data=loadMasterData();
  const dealers=[...new Set(data.map(d=>d.ë”œëŸ¬))].sort();
  const div=document.createElement('div');
  div.className='order-row';div.style.marginBottom='8px';
  div.innerHTML=`
    <select class="input-dealer" onchange="updateItemOptions(this)">
      <option value="">-- ë”œëŸ¬ ì„ íƒ --</option>${dealers.map(d=>`<option value="${d}">${d}</option>`).join('')}
    </select>
    <select class="input-item" disabled onchange="updateModelOptions(this)"><option value="">-- ì•„ì´í…œ ì„ íƒ --</option></select>
    <select class="input-model" disabled><option value="">-- ê¸°ì¢… ì„ íƒ --</option></select>
    <input type="number" class="input-quantity" value="1" min="1"><button onclick="removeRow(this)">X</button>`;
  document.getElementById('orderInputs').appendChild(div);
}
function updateItemOptions(sel){
  const dealer=sel.value,data=loadMasterData(),itemSel=sel.nextElementSibling,modelSel=itemSel.nextElementSibling;
  modelSel.disabled=true;modelSel.innerHTML='<option value="">-- ê¸°ì¢… ì„ íƒ --</option>';
  if(!dealer){itemSel.disabled=true;itemSel.innerHTML='<option value="">-- ì•„ì´í…œ ì„ íƒ --</option>';return;}
  const items=[...new Set(data.filter(d=>d.ë”œëŸ¬===dealer).map(d=>d.ì•„ì´í…œ))].sort();
  itemSel.disabled=false;itemSel.innerHTML='<option value="">-- ì•„ì´í…œ ì„ íƒ --</option>'+items.map(i=>`<option value="${i}">${i}</option>`).join('');
}
function updateModelOptions(sel){
  const dealer=sel.previousElementSibling.value,item=sel.value,data=loadMasterData(),modelSel=sel.nextElementSibling;
  if(!item){modelSel.disabled=true;modelSel.innerHTML='<option value="">-- ê¸°ì¢… ì„ íƒ --</option>';return;}
  const models=[...new Set(data.filter(d=>d.ë”œëŸ¬===dealer&&d.ì•„ì´í…œ===item).map(d=>d.ê¸°ì¢…))].sort();
  modelSel.disabled=false;modelSel.innerHTML='<option value="">-- ê¸°ì¢… ì„ íƒ --</option>'+models.map(m=>`<option value="${m}">${m}</option>`).join('');
}
function removeRow(b){b.closest('.order-row').remove();}

function calculateRequirements(){
  const data = loadMasterData();
  const rows = document.querySelectorAll('.order-row');
  const res = {};

  if (rows.length === 0) {
    alert("ì¡°í•©ì„ ì¶”ê°€í•´ì£¼ì„¸ìš”.");
    return;
  }

  rows.forEach(r => {
    const dealer = (r.querySelector('.input-dealer').value || '').trim();
    const item = (r.querySelector('.input-item').value || '').trim();
    const model = (r.querySelector('.input-model').value || '').trim().toUpperCase();
    const q = parseInt(r.querySelector('.input-quantity').value, 10) || 0;

    if (!dealer || !item || !model || q <= 0) return;

    const items = data.filter(i =>
      i.ë”œëŸ¬ === dealer &&
      i.ì•„ì´í…œ === item &&
      i.ê¸°ì¢….toUpperCase().trim() === model
    );

    if (groups.nitrogen_small.includes(model)) supplyData['A090-0021'] += q;
    if (groups.nitrogen_large.includes(model)) supplyData['A090-0007'] += q;
    if (groups.gas_small.includes(model)) supplyData['A090-0052'] += q;
    if (groups.gas_large.includes(model)) supplyData['A090-0054'] += q;

    items.forEach(i => {
      const count = (parseInt(i.ì†Œìš”ìˆ˜ëŸ‰_ë‹¨ìœ„ë‹¹, 10) || 0) * q;
      if (!res[i.í’ˆë²ˆ]) res[i.í’ˆë²ˆ] = { name: i.í’ˆëª…, total: 0, remark: i.ë¹„ê³  || '' };
      res[i.í’ˆë²ˆ].total += count;
    });
  });

  saveSupply();
  updateSupplyPanel();

  const tbody = document.querySelector('#resultTable tbody');
  tbody.innerHTML = '';

  const keys = Object.keys(res);
  if (keys.length === 0) {
    tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;">âš ï¸ ê³„ì‚° ê°€ëŠ¥í•œ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
    return;
  }

  keys.forEach(k => {
    const r = tbody.insertRow();
    r.insertCell(0).textContent = k;
    r.insertCell(1).textContent = res[k].name;
    r.insertCell(2).textContent = res[k].total;
    r.insertCell(3).textContent = res[k].remark;
  });

  document.getElementById('reportBtns').style.display = 'block';
}

function uploadMasterDataFromText(){
  const t=document.getElementById('csvTextarea').value.trim();if(!t)return alert("ë°ì´í„°ë¥¼ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”.");const d=t.includes('\t')?'\t':',';Papa.parse(t,{header:true,skipEmptyLines:true,delimiter:d,complete:handleParsedData});
}
function handleParsedData(r){
  const arr=[];
  r.data.forEach(x=>{
    if(x.ê¸°ì¢… && x.ì•„ì´í…œ && x.ë”œëŸ¬ && x.í’ˆë²ˆ && x.í’ˆëª… && x.ìˆ˜ëŸ‰){
      arr.push({
        "ê¸°ì¢…":x.ê¸°ì¢….trim(),
        "ì•„ì´í…œ":x.ì•„ì´í…œ.trim(),
        "ë”œëŸ¬":x.ë”œëŸ¬.trim(),
        "í’ˆë²ˆ":x.í’ˆë²ˆ.trim(),
        "í’ˆëª…":x.í’ˆëª….trim(),
        "ì†Œìš”ìˆ˜ëŸ‰_ë‹¨ìœ„ë‹¹":parseInt(x.ìˆ˜ëŸ‰,10),
        "ë¹„ê³ ":x.ë¹„ê³ ?x.ë¹„ê³ .trim():""
      });
    }
  });
  const existing = loadMasterData();
  const merged = existing.concat(arr);
  saveMasterData(merged);
  alert(`ì´ ${arr.length}ê°œ ë°ì´í„° ì¶”ê°€, ì „ì²´ ${merged.length}ê°œ ë°ì´í„° ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.`);
  refreshFilters();
  applyFilter();
}

function refreshFilters(){
  const data=loadMasterData();const dealers=[...new Set(data.map(x=>x.ë”œëŸ¬))].sort();const items=[...new Set(data.map(x=>x.ì•„ì´í…œ))].sort();
  const dealerSel=document.getElementById('filterDealer'),itemSel=document.getElementById('filterItem');
  dealerSel.innerHTML='<option value="">-- ë”œëŸ¬ ì „ì²´ --</option>'+dealers.map(d=>`<option value="${d}">${d}</option>`).join('');
  itemSel.innerHTML='<option value="">-- ì•„ì´í…œ ì „ì²´ --</option>'+items.map(i=>`<option value="${i}">${i}</option>`).join('');
}
function applyFilter(){
  const all=loadMasterData(),d=document.getElementById('filterDealer').value,i=document.getElementById('filterItem').value;
  filteredData=all.filter(x=>(!d||x.ë”œëŸ¬===d)&&(!i||x.ì•„ì´í…œ===i));currentPage=1;renderDataList();
}
function renderDataList(){
  const tbody=document.querySelector('#dataListTable tbody');tbody.innerHTML='';const start=(currentPage-1)*ROWS_PER_PAGE,end=start+ROWS_PER_PAGE,pageData=filteredData.slice(start,end);
  pageData.forEach(i=>{
    const r=tbody.insertRow();const cb=document.createElement('input');cb.type='checkbox';cb.className='selectRow';cb.dataset.key=`${i.ë”œëŸ¬}|${i.ì•„ì´í…œ}|${i.ê¸°ì¢…}|${i.í’ˆë²ˆ}`;
    r.insertCell(0).appendChild(cb);r.insertCell(1).textContent=i.ë”œëŸ¬;r.insertCell(2).textContent=i.ì•„ì´í…œ;r.insertCell(3).textContent=i.ê¸°ì¢…;r.insertCell(4).textContent=i.í’ˆë²ˆ;r.insertCell(5).textContent=i.í’ˆëª…;r.insertCell(6).textContent=i.ì†Œìš”ìˆ˜ëŸ‰_ë‹¨ìœ„ë‹¹;r.insertCell(7).textContent=i.ë¹„ê³ ||"";});
  renderPagination(filteredData.length);
}
function renderPagination(t){const c=document.getElementById('pagination');c.innerHTML='';const p=Math.ceil(t/ROWS_PER_PAGE);if(p<=1)return;
  const prev=document.createElement('button');prev.textContent='â—€';prev.className='page-btn';prev.disabled=currentPage===1;prev.onclick=()=>{currentPage--;renderDataList();};c.appendChild(prev);
  for(let i=1;i<=p;i++){const b=document.createElement('button');b.textContent=i;b.className='page-btn'+(i===currentPage?' active':'');b.onclick=()=>{currentPage=i;renderDataList();};c.appendChild(b);}
  const next=document.createElement('button');next.textContent='â–¶';next.className='page-btn';next.disabled=currentPage===p;next.onclick=()=>{currentPage++;renderDataList();};c.appendChild(next);
}
function selectAll(chk){document.querySelectorAll('.selectRow').forEach(c=>c.checked=chk);}
function deleteSelected(){
  const ch=document.querySelectorAll('.selectRow:checked');if(!ch.length)return alert("ì‚­ì œí•  í•­ëª©ì„ ì„ íƒí•˜ì„¸ìš”.");if(!confirm(`${ch.length}ê°œ ì‚­ì œ?`))return;
  let d=loadMasterData();ch.forEach(c=>{const[k1,k2,k3,k4]=c.dataset.key.split('|');d=d.filter(x=>!(x.ë”œëŸ¬===k1&&x.ì•„ì´í…œ===k2&&x.ê¸°ì¢…===k3&&x.í’ˆë²ˆ===k4));});
  saveMasterData(d);applyFilter();alert("ì‚­ì œ ì™„ë£Œ.");
}
function deleteByFilter(){
  const d=document.getElementById('filterDealer').value,i=document.getElementById('filterItem').value;
  if(!d&&!i)return alert("í•„í„°ë¥¼ ì„ íƒí•˜ì„¸ìš”.");if(!confirm(`ë”œëŸ¬(${d||'ì „ì²´'}) / ì•„ì´í…œ(${i||'ì „ì²´'}) ë°ì´í„° ì „ì²´ ì‚­ì œ?`))return;
  let data=loadMasterData();data=data.filter(x=>!((!d||x.ë”œëŸ¬===d)&&(!i||x.ì•„ì´í…œ===i)));saveMasterData(data);applyFilter();alert("í•„í„° ì¡°ê±´ ë°ì´í„° ì‚­ì œ ì™„ë£Œ.");
}
function deleteAll(){
  const pw=prompt("ì „ì²´ ì‚­ì œ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:");if(pw!==ADMIN_PASSWORD)return alert("ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.");
  if(confirm("âš  ëª¨ë“  ë°ì´í„°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")){localStorage.removeItem(LOCAL_STORAGE_KEY);applyFilter();alert("ì „ì²´ ë°ì´í„° ì‚­ì œ ì™„ë£Œ.");}
}

async function downloadPDF() {
  const { jsPDF } = window.jspdf;

  if (typeof html2canvas === "undefined") {
    await new Promise((resolve, reject) => {
      const script = document.createElement("script");
      script.src = "https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js";
      script.onload = resolve;
      script.onerror = reject;
      document.head.appendChild(script);
    });
  }

  const container = document.querySelector(".container");
  const logo = document.getElementById("ciLogo");

  // âœ… ë¡œê³  ì ì‹œ ìˆ¨ê¸°ê¸° (CORS ë°©ì§€)
  const prevDisplay = logo.style.display;
  logo.style.display = "none";

  // âœ… í™”ë©´ ìº¡ì²˜
  const canvas = await html2canvas(container, {
    scale: 2,
    useCORS: true,
    logging: false,
  });

  // ë‹¤ì‹œ ë¡œê³  ë³µì›
  logo.style.display = prevDisplay;

  const imgData = canvas.toDataURL("image/png");
  const pdf = new jsPDF("p", "mm", "a4");
  const pageWidth = pdf.internal.pageSize.getWidth();
  const imgHeight = (canvas.height * pageWidth) / canvas.width;

  pdf.addImage(imgData, "PNG", 0, 0, pageWidth, imgHeight);
  pdf.save(`ë¬´ìƒí’ˆ ì†Œìš”ëŸ‰ ${new Date().toISOString().slice(0,10)}.pdf`);
}

function downloadExcel() {
  const table = document.getElementById('resultTable');
  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.table_to_sheet(table);
  XLSX.utils.book_append_sheet(wb, ws, 'ê²°ê³¼');
  const date = new Date();
  const fileName = `${date.getMonth() + 1}-${date.getDate()} ë¬´ìƒí’ˆ ì†Œìš”ëŸ‰.xlsx`;
  XLSX.writeFile(wb, fileName);
}

async function loadMasterDataFromServer() {
  try {
    console.log("ğŸ”„ master.json ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...");
    const response = await fetch("./data/master.json", { cache: "no-store" }); // ìºì‹œ ë°©ì§€
    if (!response.ok) throw new Error(`HTTP ${response.status}`);
    const json = await response.json();

    if (Array.isArray(json) && json.length > 0) {
      saveMasterData(json);
      console.log(`âœ… ì„œë²„ì—ì„œ ${json.length}ê°œ í•­ëª© ë¶ˆëŸ¬ì˜´`);
    } else {
      console.warn("âš ï¸ master.jsonì€ ë¹„ì–´ìˆê±°ë‚˜ ë°°ì—´ í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤.");
    }
  } catch (err) {
    console.error("âŒ ë§ˆìŠ¤í„°ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:", err);
  }
}

// âœ… í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰
window.addEventListener("DOMContentLoaded", async () => {
  try {
    const localData = loadMasterData();
    console.log(`ğŸ“¦ ë¡œì»¬ë°ì´í„°: ${localData.length}ê°œ`);

    if (!localData || localData.length === 0) {
      await loadMasterDataFromServer();
    }

    addRow();
    updateSupplyPanel();
    console.log("âœ… ì´ˆê¸°í™” ì™„ë£Œ");
  } catch (err) {
    console.error("âš ï¸ ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜:", err);
  }
});
</script>
</body>
</html>
