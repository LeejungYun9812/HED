<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>êµ¬ë§¤íŒ€ ë¬´ìƒí’ˆ ì†Œìš”ëŸ‰ ê³„ì‚°ê¸° (í˜„ëŒ€ì—ë²„ë‹¤ì„ CI ë””ìì¸)</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;700&display=swap" rel="stylesheet">
    
    <script type="module">
        // ë¡œì»¬ íŒŒì¼ papaparse.min.jsì˜ ì½”ë“œë¥¼ ì‹¤í–‰í•˜ì—¬ PapaParse ê°ì²´ë¥¼ ì „ì—­ì— ì •ì˜í•©ë‹ˆë‹¤.
        import './papaparse.min.js';
        
        // PapaParseê°€ ì „ì—­ì—ì„œ ì •ì˜ë˜ì§€ ì•Šì•˜ë‹¤ë©´ ì˜¤ë¥˜ë¥¼ ë°œìƒì‹œì¼œ ë¬¸ì œê°€ í•´ê²°ë˜ì—ˆëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤.
        if (typeof PapaParse === 'undefined') {
            console.error("PapaParse ë¡œë“œ ì‹¤íŒ¨: ë¡œì»¬ íŒŒì¼ì´ ë¹„ì–´ ìˆê±°ë‚˜ ì†ìƒë˜ì—ˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
        }
    </script>
    
    <style>
        /* (CSS ìŠ¤íƒ€ì¼ì€ ìƒëµ) */
        :root {
            --color-primary: #009688; 
            --color-secondary: #CC9933; 
            --color-dark: #212121; 
            --color-light: #f4f7f6; 
            --color-white: #ffffff;
        }

        body { 
            font-family: 'Noto Sans KR', sans-serif; 
            font-weight: 400;
            padding: 0;
            background-color: var(--color-light); 
        }
        .container { 
            max-width: 900px; 
            margin: 20px auto; 
            background: var(--color-white); 
            padding: 30px; 
            border-radius: 4px; 
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }
        
        .header-section { 
            display: flex; 
            justify-content: space-between; 
            align-items: flex-start; 
            margin-bottom: 20px;
        }
        
        .logo-container {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }
        #ciLogo {
            max-width: 150px; 
            height: auto;
            margin-bottom: 10px;
        }

        .ci-title {
            color: var(--color-primary); 
            font-size: 24px;
            font-weight: 700;
            margin: 0;
            margin-top: 10px; 
        }
        h3 { 
            color: var(--color-dark); 
            border-bottom: 3px solid var(--color-primary); 
            padding-bottom: 8px; 
            margin-top: 25px; 
            font-weight: 700;
            font-size: 18px;
        }
        
        #adminButton { 
            padding: 8px 15px; 
            background-color: var(--color-secondary); 
            color: var(--color-white); 
            border: none; 
            border-radius: 4px; 
            cursor: pointer; 
            font-weight: 700;
            transition: background-color 0.3s; 
        }
        #adminButton:hover { background-color: #b3862d; }

        .order-row select, .order-row input, .data-input input { 
            padding: 8px; 
            border: 1px solid #ddd; 
            border-radius: 4px; 
            box-sizing: border-box; 
            font-family: 'Noto Sans KR', sans-serif;
        }

        #calculateButton { 
            background-color: var(--color-primary); 
            color: var(--color-white); 
        }
        #calculateButton:hover { background-color: #00796b; }
        
        .report-buttons button { 
            font-weight: 700;
            margin-left: 5px;
            padding: 8px 15px;
            border: none;
            border-radius: 4px;
            color: white;
            cursor: pointer;
        }
        #printButton { background-color: #dc3545; } 
        #downloadButton { background-color: var(--color-secondary); }


        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { 
            border: 1px solid #eee; 
            padding: 12px; 
            text-align: left; 
            font-size: 14px;
        }
        th { 
            background-color: var(--color-light); 
            color: var(--color-dark); 
            font-weight: 700;
        }
        .total-row { 
            font-weight: 700; 
            background-color: #e6f7ff; 
            color: var(--color-dark);
        }
        
        #adminSection { 
            border: 1px solid var(--color-secondary); 
            background-color: #fffaf0; 
            padding: 20px;
            margin-top: 20px;
            display: none; 
        }
        #adminSection button[onclick="uploadMasterDataFromCsv()"] {
             background-color: var(--color-primary); 
        }
        #uploadTextButton {
            background-color: #3f51b5; 
        }

        .action-button { background-color: #dc3545; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer;}
        .data-input-grid { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr 1fr 0.5fr; gap: 10px; margin-bottom: 15px; }


        @media print {
            .logo-container, .ci-title { text-align: center; }
            #ciLogo { max-width: 100px; margin: 10px auto; }
            .ci-title { border-bottom: 3px solid var(--color-dark); color: var(--color-dark); font-size: 20px; padding-bottom: 10px; margin-bottom: 15px; }
            .container { box-shadow: none; border: none; margin: 0; padding: 0; }
            #adminButton, #adminSection, #inputArea, #addRowButton, #calculateButton, .report-buttons { display: none !important; }
            h3 { display: none; }
            table, th, td { border-color: #000 !important; }
            th { background-color: #ddd !important; -webkit-print-color-adjust: exact; color: #000; }
        }
    </style>
</head>
<body>
    
    <div class="container">
        <div class="header-section">
            <div class="logo-container">
                <img id="ciLogo" src="everdigm_logo.png" alt="í˜„ëŒ€ì—ë²„ë‹¤ì„ CI ë¡œê³ "> 
                <div class="ci-title">ë¬´ìƒí’ˆ ë°œì£¼ ì†Œìš” ìˆ˜ëŸ‰ ê³„ì‚°ê¸°</div>
            </div>
            <button id="adminButton" onclick="toggleAdminMode()">ê´€ë¦¬ì ëª¨ë“œ ì—´ê¸°</button>
        </div>
        
        <h3>ë°œì£¼ ì¡°í•© ì…ë ¥</h3>
        <div id="inputArea">
            <div class="order-row" style="font-weight: bold; border-bottom: 1px solid #ccc; padding-bottom: 5px;">
                <span>ê¸°ì¢…</span>
                <span>ë”œëŸ¬</span>
                <span>ì¶œê³  ìˆ˜ëŸ‰</span>
                <span>ì‚­ì œ</span>
            </div>
            <div id="orderInputs">
                </div>
            <button id="addRowButton" onclick="addRow()">+ ì¡°í•© ì¶”ê°€</button>
            <button id="calculateButton" onclick="calculateRequirements()">ì´ ì†Œìš”ëŸ‰ ê³„ì‚°</button>
        </div>
        
        <div class="report-buttons" style="text-align: right; margin-bottom: 10px;">
            <button id="printButton" onclick="printReport()" style="display: none;">
                ğŸ“„ PDF ë³´ê³ ì„œ ì¸ì‡„ (Ctrl+P)
            </button>
            <button id="downloadButton" onclick="downloadCsv()" style="display: none;">
                ğŸ’¾ ê³„ì‚° ê²°ê³¼ Excel ë‹¤ìš´ë¡œë“œ (CSV)
            </button>
        </div>

        <h3>ì´ ì†Œìš”ëŸ‰ ê²°ê³¼</h3>
        <table id="resultTable">
            <thead>
                <tr>
                    <th>í’ˆë²ˆ</th>
                    <th>í’ˆëª…</th>
                    <th>ì´ ì†Œìš” ìˆ˜ëŸ‰</th>
                </tr>
            </thead>
            <tbody>
                <tr><td colspan="3" style="text-align: center;">ì¡°í•©ì„ ì…ë ¥í•˜ê³  ê³„ì‚° ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.</td></tr>
            </tbody>
        </table>
    </div>

    <div class="container" id="adminSection">
        <h3>âš™ï¸ ë§ˆìŠ¤í„° ë°ì´í„° ê´€ë¦¬ (ê´€ë¦¬ì ì „ìš©)</h3>
        <p style="color: #dc3545;">ì£¼ì˜: íŒŒì¼ ì—…ë¡œë“œ/í…ìŠ¤íŠ¸ ê°±ì‹  ì‹œ ê¸°ì¡´ ë°ì´í„°ëŠ” ëª¨ë‘ ë®ì–´ì“°ê¸° ë©ë‹ˆë‹¤.</p>

        <h4>1. ì—‘ì…€ íŒŒì¼ (CSV) ì—…ë¡œë“œë¡œ ë°ì´í„° ì¼ê´„ ê°±ì‹ </h4>
        <div style="display: flex; gap: 10px; margin-bottom: 10px; align-items: center;">
            <input type="file" id="csvFileInput" accept=".csv" style="flex-grow: 1;">
            <button onclick="uploadMasterDataFromCsv()">
                â¬†ï¸ CSV íŒŒì¼ ê°±ì‹ 
            </button>
        </div>
        <p style="font-size: 12px; color: #555;">(íŒŒì¼ ì—…ë¡œë“œ ê¸°ëŠ¥ì— ì˜¤ë¥˜ê°€ ìˆë‹¤ë©´ ì•„ë˜ í…ìŠ¤íŠ¸ ë¶™ì—¬ë„£ê¸° ê¸°ëŠ¥ì„ ì‚¬ìš©í•˜ì„¸ìš”.)</p>

        <hr style="border-top: 1px solid #ddd; margin: 20px 0;">

        <h4>2. ì—‘ì…€ ë°ì´í„° ì§ì ‘ ë¶™ì—¬ë„£ê¸°ë¡œ ë°ì´í„° ì¼ê´„ ê°±ì‹ </h4>
        <textarea id="csvTextarea" rows="10" placeholder="ì—¬ê¸°ì— ì—‘ì…€/CSV ë°ì´í„°ë¥¼ í—¤ë”(ê¸°ì¢…,ë”œëŸ¬,í’ˆë²ˆ,í’ˆëª…,ìˆ˜ëŸ‰,ë¹„ê³ ) í¬í•¨í•˜ì—¬ ë³µì‚¬/ë¶™ì—¬ë„£ê¸° í•˜ì„¸ìš”." style="width: 100%; padding: 10px; box-sizing: border-box; margin-bottom: 10px;"></textarea>
        <button id="uploadTextButton" onclick="uploadMasterDataFromText()">
            ğŸ“‹ í…ìŠ¤íŠ¸ ë°ì´í„° ê°±ì‹ 
        </button>
        
        <p style="font-size: 12px; color: #555; margin-top: 10px;">(ë¶™ì—¬ë„£ê¸° ë°ì´í„° í˜•ì‹: **ê¸°ì¢…,ë”œëŸ¬,í’ˆë²ˆ,í’ˆëª…,ìˆ˜ëŸ‰,ë¹„ê³ ** ìˆœì„œì—¬ì•¼ í•©ë‹ˆë‹¤.)</p>

        <hr style="border-top: 1px solid #ddd; margin: 20px 0;">
        
        <h4>3. ë‹¨ì¼ ë°ì´í„° ìˆ˜ë™ ì¶”ê°€</h4>
        <div class="data-input-grid">
            <input type="text" id="inputDealer" placeholder="ë”œëŸ¬" required>
            <input type="text" id="inputModel" placeholder="ê¸°ì¢…" required>
            <input type="text" id="inputPartNumber" placeholder="í’ˆë²ˆ" required>
            <input type="text" id="inputPartName" placeholder="í’ˆëª…" required>
            <input type="number" id="inputQuantity" placeholder="ë‹¨ìœ„ë‹¹ ìˆ˜ëŸ‰" min="1" value="1" required>
            <button onclick="addData()">ì¶”ê°€</button>
        </div>

        <h4>4. í˜„ì¬ ì €ì¥ëœ ë°ì´í„° í™•ì¸ ë° ì‚­ì œ</h4>
        <table id="dataListTable">
            <thead>
                <tr>
                    <th>ë”œëŸ¬</th>
                    <th>ê¸°ì¢…</th>
                    <th>í’ˆë²ˆ</th>
                    <th>í’ˆëª…</th>
                    <th>ì†Œìš”ìˆ˜ëŸ‰</th>
                    <th>ì‚­ì œ</th>
                </tr>
            </thead>
            <tbody>
                </tbody>
        </table>
    </div>

<script>
// --- [1] ìƒìˆ˜ ë° ì´ˆê¸° ë°ì´í„° ì„¤ì • ---
const LOCAL_STORAGE_KEY = 'everdigm_attachment_master_data';
const ADMIN_PASSWORD = 'êµ¬ë§¤íŒ€ì§±'; // ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ë¥¼ ë°˜ë“œì‹œ ë³€ê²½í•˜ì„¸ìš”!
const INITIAL_MASTER_DATA = [
    { "ê¸°ì¢…": "HMB150", "ë”œëŸ¬": "A_DEALER", "í’ˆë²ˆ": "SEAL-001", "í’ˆëª…": "BREAKER_SEAL_KIT_BASIC", "ì†Œìš”ìˆ˜ëŸ‰_ë‹¨ìœ„ë‹¹": 1 },
    { "ê¸°ì¢…": "HMB150", "ë”œëŸ¬": "A_DEALER", "í’ˆë²ˆ": "CHISEL-003", "í’ˆëª…": "CHISEL_STANDARD_LONG", "ì†Œìš”ìˆ˜ëŸ‰_ë‹¨ìœ„ë‹¹": 2 },
    { "ê¸°ì¢…": "HMB200", "ë”œëŸ¬": "B_DEALER", "í’ˆë²ˆ": "TOOL-010", "í’ˆëª…": "TOOL KIT STANDARD", "ì†Œìš”ìˆ˜ëŸ‰_ë‹¨ìœ„ë‹¹": 1 },
];


// --- [2] Local Storage ë°ì´í„° ê´€ë¦¬ í•¨ìˆ˜ (ìœ ì§€) ---
function loadMasterData() {
    const dataString = localStorage.getItem(LOCAL_STORAGE_KEY);
    if (!dataString) {
        saveMasterData(INITIAL_MASTER_DATA);
        return INITIAL_MASTER_DATA;
    }
    return JSON.parse(dataString);
}
function saveMasterData(data) {
    localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(data));
}


// --- [3] ë‹¤ì¤‘ ì…ë ¥ ë° ê³„ì‚° ê´€ë ¨ í•¨ìˆ˜ (ìœ ì§€) ---
function getSelectOptions() {
    const MASTER_DATA = loadMasterData();
    const models = [...new Set(MASTER_DATA.map(item => item.ê¸°ì¢…))].sort();
    const dealers = [...new Set(MASTER_DATA.map(item => item.ë”œëŸ¬))].sort();
    
    let modelOptions = '<option value="">-- ê¸°ì¢… ì„ íƒ --</option>';
    models.forEach(m => modelOptions += `<option value="${m}">${m}</option>`);

    let dealerOptions = '<option value="">-- ë”œëŸ¬ ì„ íƒ --</option>';
    dealers.forEach(d => dealerOptions += `<option value="${d}">${d}</option>`);

    return { modelOptions, dealerOptions };
}

function addRow() {
    const { modelOptions, dealerOptions } = getSelectOptions();
    const orderInputs = document.getElementById('orderInputs');
    
    const newRow = document.createElement('div');
    newRow.className = 'order-row';
    newRow.innerHTML = `
        <select class="input-model">${modelOptions}</select>
        <select class="input-dealer">${dealerOptions}</select>
        <input type="number" class="input-quantity" value="1" min="1">
        <button onclick="removeRow(this)">X</button>
    `;
    orderInputs.appendChild(newRow);
    resetCalculationDisplay();
}

function removeRow(button) {
    button.closest('.order-row').remove();
    resetCalculationDisplay();
}

function resetCalculationDisplay() {
    const resultBody = document.getElementById('resultTable').querySelector('tbody');
    resultBody.innerHTML = '<tr><td colspan="3" style="text-align: center;">ì¡°í•©ì„ ì…ë ¥í•˜ê³  ê³„ì‚° ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.</td></tr>';
    document.getElementById('printButton').style.display = 'none';
    document.getElementById('downloadButton').style.display = 'none';
}

function calculateRequirements() {
    const MASTER_DATA = loadMasterData();
    const orderRows = document.querySelectorAll('#orderInputs .order-row');
    const resultBody = document.getElementById('resultTable').querySelector('tbody');
    const requiredTotal = {}; 
    
    let isValid = true;
    if (orderRows.length === 0) {
        alert("ìµœì†Œí•œ í•˜ë‚˜ì˜ ë°œì£¼ ì¡°í•©ì„ ì¶”ê°€í•´ ì£¼ì„¸ìš”.");
        isValid = false;
    }

    const orders = [];
    orderRows.forEach(row => {
        const model = row.querySelector('.input-model').value;
        const dealer = row.querySelector('.input-dealer').value;
        const quantity = parseInt(row.querySelector('.input-quantity').value, 10);

        if (!model || !dealer || isNaN(quantity) || quantity < 1) {
            isValid = false;
        }
        orders.push({ model, dealer, quantity });
    });

    if (!isValid) {
        alert("ëª¨ë“  ì¡°í•©ì˜ ê¸°ì¢…, ë”œëŸ¬ë¥¼ ì„ íƒí•˜ê³  ìœ íš¨í•œ ì¶œê³  ìˆ˜ëŸ‰ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.");
        resetCalculationDisplay();
        return;
    }

    orders.forEach(order => {
        const { model, dealer, quantity } = order;
        
        const matchingItems = MASTER_DATA.filter(item => 
            item.ê¸°ì¢… === model && item.ë”œëŸ¬ === dealer
        );

        if (matchingItems.length === 0) {
            console.warn(`ê²½ê³ : ê¸°ì¢… ${model} / ë”œëŸ¬ ${dealer} ì¡°í•©ì— ëŒ€í•œ ë§ˆìŠ¤í„° ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.`);
            return;
        }

        matchingItems.forEach(item => {
            const requiredCount = item.ì†Œìš”ìˆ˜ëŸ‰_ë‹¨ìœ„ë‹¹ * quantity;
            const partNumber = item.í’ˆë²ˆ;

            if (requiredTotal[partNumber]) {
                requiredTotal[partNumber].totalQuantity += requiredCount;
            } else {
                requiredTotal[partNumber] = {
                    totalQuantity: requiredCount,
                    partName: item.í’ˆëª…
                };
            }
        });
    });

    resultBody.innerHTML = ''; 
    const requiredParts = Object.keys(requiredTotal).sort();
    let grandTotalItems = 0;
    
    if (requiredParts.length === 0) {
        const row = resultBody.insertRow();
        const cell = row.insertCell(0);
        cell.colSpan = 3;
        cell.style.textAlign = 'center';
        cell.textContent = `âš ï¸ ê³„ì‚° ê°€ëŠ¥í•œ í’ˆëª©ì´ ì—†ìŠµë‹ˆë‹¤. ë§ˆìŠ¤í„° ë°ì´í„°ë¥¼ í™•ì¸í•´ ì£¼ì„¸ìš”.`;
        resetCalculationDisplay();
        return;
    }

    requiredParts.forEach(partNumber => {
        const data = requiredTotal[partNumber];
        grandTotalItems += data.totalQuantity;

        const row = resultBody.insertRow();
        row.insertCell(0).textContent = partNumber;
        row.insertCell(1).textContent = data.partName || 'ì •ë³´ ì—†ìŒ';
        row.insertCell(2).textContent = data.totalQuantity.toLocaleString();
    });

    const totalRow = resultBody.insertRow();
    totalRow.className = 'total-row';
    totalRow.insertCell(0).textContent = 'ì´ ì†Œìš” í’ˆëª© ìˆ˜ëŸ‰ í•©ê³„';
    totalRow.insertCell(1).textContent = '';
    totalRow.insertCell(2).textContent = grandTotalItems.toLocaleString();
    
    document.getElementById('printButton').style.display = 'inline-block'; 
    document.getElementById('downloadButton').style.display = 'inline-block';
}


// --- [4] ê´€ë¦¬ì ëª¨ë“œ ë° ë°ì´í„° ê°±ì‹  í•¨ìˆ˜ ---

let isAdminMode = false;

function toggleAdminMode() {
    const adminSection = document.getElementById('adminSection');
    const adminButton = document.getElementById('adminButton');

    if (!isAdminMode) {
        const password = prompt("ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:");
        if (password === ADMIN_PASSWORD) {
            isAdminMode = true;
            adminSection.style.display = 'block';
            adminButton.textContent = 'ê´€ë¦¬ì ëª¨ë“œ ë‹«ê¸°';
            renderDataList();
        } else {
            alert("ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.");
        }
    } else {
        isAdminMode = false;
        adminSection.style.display = 'none';
        adminButton.textContent = 'ê´€ë¦¬ì ëª¨ë“œ ì—´ê¸°';
    }
}

// 4-1. CSV íŒŒì¼ ì—…ë¡œë“œ ê¸°ëŠ¥
function uploadMasterDataFromCsv() {
    // PapaParse ì •ì˜ ì—¬ë¶€ ì¬í™•ì¸ (í˜¹ì‹œ ëª¨ë¥¼ ì˜¤ë¥˜ ëŒ€ë¹„)
    if (typeof PapaParse === 'undefined') {
        alert("ë°ì´í„° ì²˜ë¦¬ ë¼ì´ë¸ŒëŸ¬ë¦¬(PapaParse) ë¡œë“œ ì‹¤íŒ¨: íŒŒì¼ì„ í™•ì¸í•˜ê³  ìƒˆë¡œê³ ì¹¨ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
        return;
    }

    const fileInput = document.getElementById('csvFileInput');
    const file = fileInput.files[0];

    if (!file) {
        alert("ì—…ë¡œë“œí•  CSV íŒŒì¼ì„ ì„ íƒí•´ ì£¼ì„¸ìš”.");
        return;
    }
    
    if (!file.name.endsWith('.csv')) {
        alert("CSV íŒŒì¼ë§Œ ì—…ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
        return;
    }

    PapaParse.parse(file, {
        header: true, 
        skipEmptyLines: true,
        dynamicTyping: true, 
        complete: handleParsedData,
        error: function(error) {
            alert("CSV íŒŒì‹± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + error);
        }
    });
}

// 4-2. í…ìŠ¤íŠ¸ ë°•ìŠ¤ ë¶™ì—¬ë„£ê¸° ê¸°ëŠ¥
function uploadMasterDataFromText() {
    // PapaParse ì •ì˜ ì—¬ë¶€ ì¬í™•ì¸
     if (typeof PapaParse === 'undefined') {
        alert("ë°ì´í„° ì²˜ë¦¬ ë¼ì´ë¸ŒëŸ¬ë¦¬(PapaParse) ë¡œë“œ ì‹¤íŒ¨: í…ìŠ¤íŠ¸ë¥¼ ë¶™ì—¬ë„£ê¸° ì „ì— ìƒˆë¡œê³ ì¹¨ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
        return;
    }

    const csvText = document.getElementById('csvTextarea').value;

    if (!csvText.trim()) {
        alert("í…ìŠ¤íŠ¸ ì…ë ¥ ì˜ì—­ì— ë°ì´í„°ë¥¼ ë¶™ì—¬ë„£ì–´ ì£¼ì„¸ìš”.");
        return;
    }

    PapaParse.parse(csvText, {
        header: true, 
        skipEmptyLines: true,
        dynamicTyping: true, 
        complete: handleParsedData,
        error: function(error) {
            alert("í…ìŠ¤íŠ¸ íŒŒì‹± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + error);
        }
    });
}


// 4-3. íŒŒì‹±ëœ ë°ì´í„°ë¥¼ ì²˜ë¦¬í•˜ê³  ì €ì¥í•˜ëŠ” ê³µí†µ í•¨ìˆ˜
function handleParsedData(results) {
    const newMasterData = [];
    const requiredHeaders = ['ê¸°ì¢…', 'ë”œëŸ¬', 'í’ˆë²ˆ', 'í’ˆëª…', 'ìˆ˜ëŸ‰', 'ë¹„ê³ '];

    const headers = results.meta.fields;
    let headerCheck = true;
    
    if (!headers || headers.length < requiredHeaders.length) {
        headerCheck = false;
    } else {
        for(let i=0; i<requiredHeaders.length; i++) {
            // í—¤ë”ê°€ ì •ì˜ëœ ìˆœì„œì™€ ë‚´ìš©ì´ ì¼ì¹˜í•˜ëŠ”ì§€ í™•ì¸
            if (headers[i] !== requiredHeaders[i]) {
                headerCheck = false;
                break;
            }
        }
    }
    
    if (!headerCheck) {
        alert(`âš ï¸ ë°ì´í„° ê°±ì‹  ì‹¤íŒ¨: ë°ì´í„°ì˜ í—¤ë” ìˆœì„œê°€ ì˜ëª»ë˜ì—ˆê±°ë‚˜ í˜•ì‹ì´ ë¶ˆì™„ì „í•©ë‹ˆë‹¤. ë°˜ë“œì‹œ '${requiredHeaders.join(',')}' ìˆœì„œì—¬ì•¼ í•©ë‹ˆë‹¤. (í™•ì¸ëœ í—¤ë”: ${headers ? headers.slice(0, 6).join(', ') : 'í—¤ë” ì—†ìŒ'})`);
        return;
    }

    let rowCount = 0;
    let errorCount = 0;
    results.data.forEach(row => {
        rowCount++;
        
        const quantity = parseInt(row['ìˆ˜ëŸ‰'], 10);

        if (row['ê¸°ì¢…'] && row['ë”œëŸ¬'] && row['í’ˆë²ˆ'] && row['í’ˆëª…'] && !isNaN(quantity) && quantity >= 0) {
            newMasterData.push({
                "ê¸°ì¢…": String(row['ê¸°ì¢…']).trim().toUpperCase(),
                "ë”œëŸ¬": String(row['ë”œëŸ¬']).trim().toUpperCase(),
                "í’ˆë²ˆ": String(row['í’ˆë²ˆ']).trim().toUpperCase(),
                "í’ˆëª…": String(row['í’ˆëª…']).trim(),
                "ì†Œìš”ìˆ˜ëŸ‰_ë‹¨ìœ„ë‹¹": quantity 
            });
        } else {
            errorCount++;
            console.warn(`í–‰ ${rowCount} ë¬´ì‹œë¨ (í•„ìˆ˜ í•„ë“œ ëˆ„ë½ ë˜ëŠ” ìˆ˜ëŸ‰ ì˜¤ë¥˜):`, row);
        }
    });

    if (newMasterData.length > 0) {
        saveMasterData(newMasterData);
        
        renderDataList();
        addRow(); 
        
        alert(`ë°ì´í„° ê°±ì‹  ì„±ê³µ! ì´ ${newMasterData.length}ê°œ í•­ëª©ì´ Local Storageì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤. (ì˜¤ë¥˜ í–‰: ${errorCount}ê°œ)`);
        document.getElementById('csvFileInput').value = ''; // íŒŒì¼ ì…ë ¥ ì´ˆê¸°í™”
        document.getElementById('csvTextarea').value = ''; // í…ìŠ¤íŠ¸ ì˜ì—­ ì´ˆê¸°í™”
    } else {
        alert("âŒ ë°ì´í„° ê°±ì‹  ì‹¤íŒ¨: ì…ë ¥ëœ ë°ì´í„°ì—ì„œ ìœ íš¨í•œ í•­ëª©ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
    }
}


function addData() {
    const dealer = document.getElementById('inputDealer').value.trim();
    const model = document.getElementById('inputModel').value.trim();
    const partNumber = document.getElementById('inputPartNumber').value.trim();
    const partName = document.getElementById('inputPartName').value.trim();
    const quantity = parseInt(document.getElementById('inputQuantity').value, 10);

    if (!model || !dealer || !partNumber || !partName || isNaN(quantity) || quantity < 1) {
        alert("ëª¨ë“  í•„ë“œë¥¼ ì •í™•í•˜ê²Œ ì…ë ¥í•´ ì£¼ì„¸ìš”.");
        return;
    }

    const MASTER_DATA = loadMasterData();
    MASTER_DATA.push({
        "ê¸°ì¢…": model.toUpperCase(),
        "ë”œëŸ¬": dealer.toUpperCase(),
        "í’ˆë²ˆ": partNumber.toUpperCase(),
        "í’ˆëª…": partName,
        "ì†Œìš”ìˆ˜ëŸ‰_ë‹¨ìœ„ë‹¹": quantity
    });

    saveMasterData(MASTER_DATA);
    alert("ë°ì´í„°ê°€ ì„±ê³µì ìœ¼ë¡œ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.");
    renderDataList();
    addRow(); 
    
    document.getElementById('inputDealer').value = ''; 
    document.getElementById('inputModel').value = '';
    document.getElementById('inputPartNumber').value = '';
    document.getElementById('inputPartName').value = '';
    document.getElementById('inputQuantity').value = '1';
}

function renderDataList() {
    const MASTER_DATA = loadMasterData();
    const dataBody = document.getElementById('dataListTable').querySelector('tbody');
    dataBody.innerHTML = '';

    MASTER_DATA.sort((a, b) => {
        if (a.ë”œëŸ¬ < b.ë”œëŸ¬) return -1; 
        if (a.ë”œëŸ¬ > b.ë”œëŸ¬) return 1;
        if (a.ê¸°ì¢… < b.ê¸°ì¢…) return -1;
        if (a.ê¸°ì¢… > b.ê¸°ì¢…) return 1;
        return 0;
    });

    MASTER_DATA.forEach((item, index) => {
        const row = dataBody.insertRow();
        row.insertCell(0).textContent = item.ë”œëŸ¬;
        row.insertCell(1).textContent = item.ê¸°ì¢…;
        row.insertCell(2).textContent = item.í’ˆë²ˆ;
        row.insertCell(3).textContent = item.í’ˆëª…;
        row.insertCell(4).textContent = item.ì†Œìš”ìˆ˜ëŸ‰_ë‹¨ìœ„ë‹¹;
        
        const deleteCell = row.insertCell(5);
        const deleteButton = document.createElement('button');
        deleteButton.textContent = 'ì‚­ì œ';
        deleteButton.className = 'action-button';
        deleteButton.onclick = () => deleteData(item.ê¸°ì¢…, item.ë”œëŸ¬, item.í’ˆë²ˆ);
        deleteCell.appendChild(deleteButton);
    });
}

function deleteData(model, dealer, partNumber) {
    if (confirm(`ì •ë§ë¡œ ê¸°ì¢…: ${model}, ë”œëŸ¬: ${dealer}, í’ˆë²ˆ: ${partNumber} í•­ëª©ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
        let MASTER_DATA = loadMasterData();
        
        MASTER_DATA = MASTER_DATA.filter(item => 
            !(item.ê¸°ì¢… === model && item.ë”œëŸ¬ === dealer && item.í’ˆë²ˆ === partNumber)
        );

        saveMasterData(MASTER_DATA);
        
        alert("ë°ì´í„°ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
        renderDataList();
        addRow();
    }
}


// --- [5] ë³´ê³ ì„œ ë° ë‹¤ìš´ë¡œë“œ í•¨ìˆ˜ (ìœ ì§€) ---

function printReport() {
    window.print(); 
}

function downloadCsv() {
    const table = document.getElementById('resultTable');
    const rows = table.querySelectorAll('tr');
    let csv = [];

    const headerRow = rows[0];
    let header = [];
    headerRow.querySelectorAll('th').forEach(th => {
        header.push(th.textContent.trim());
    });
    csv.push(header.join(','));

    for (let i = 1; i < rows.length; i++) {
        const row = rows[i];
        let rowData = [];
        if (!row.classList.contains('total-row')) { 
            row.querySelectorAll('td').forEach(cell => {
                let cellData = cell.textContent.trim().replace(/"/g, '""');
                cellData = cellData.replace(/,/g, ''); 
                rowData.push(`"${cellData}"`);
            });
            csv.push(rowData.join(','));
        }
    }
    
    const csvString = csv.join('\n');
    const blob = new Blob(["\ufeff", csvString], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement("a");
    
    const today = new Date().toISOString().slice(0, 10).replace(/-/g, '');
    link.href = URL.createObjectURL(blob);
    link.download = `ë‹¤ì¤‘ë°œì£¼_ì´ì†Œìš”ëŸ‰_${today}.csv`;
    
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}


// ì›¹í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸° í–‰ ì¶”ê°€
window.onload = function() {
    addRow(); 
};
</script>

</body>
</html>